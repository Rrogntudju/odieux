<html>
    <head>
      <meta charset="utf-8"/>
      <meta name="viewport" content="width=device-width, initial-scale=1">
      <script src="dist/knockout-3.5.1.js"></script>
      <link rel="stylesheet" href="dist/w3.css">
      <link rel="icon" type="image/x-icon" href="dist/favicon.ico"/>
      <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
     </head>

    <body>
      <header>
        <div class="w3-container w3-teal">
          <div class="w3-container w3-cell"><h4>C'est si bon</h4></div>
        </div>

        <div class="w3-container w3-teal">
          <div class="w3-container w3-cell">
            <span class="w3-button w3-green w3-round-large" 
                  data-bind="hidden: player() == 'Playing', css: { 'w3-disabled': playerOff }, click: toggle">
              <i class="fa fa-play"></i>
            </span>
            <span class="w3-button w3-green w3-round-large" 
                  data-bind="hidden: player() == 'Paused', css: { 'w3-disabled': playerOff }, click: toggle">
              <i class="fa fa-pause"></i>
            </span>
            <span class="w3-button w3-green w3-round-large" 
                  data-bind="css: { 'w3-disabled': playerOff }, click: stop">
              <i class="fa fa-stop"></i>
            </span>
          </div>

          <div class="w3-container w3-cell">
            <span class="w3-button w3-green w3-round-large" 
                  data-bind="css: { 'w3-disabled': playerOff }, click: setVolume.bind($data, -1)">
              <i class="fa fa-volume-down"></i>
            </span>
            <span class="w3-badge w3-white" data-bind="text: volume, css: { 'w3-disabled': playerOff }"></span>
            <span class="w3-button w3-green w3-round-large" 
                  data-bind="css: { 'w3-disabled': playerOff }, click: setVolume.bind($data, 1)">
              <i class="fa fa-volume-up"></i>
            </span>
          </div>
        </div>

        <div class="w3-container w3-teal">
          <div class="w3-container" data-bind="using: enLecture">
            <p data-bind="text: titre"></p>
          </div>
        </div>
      </header>

      <div class= "w3-container" data-bind="foreach: épisodes">
        <div class="w3-card w3-round w3-margin-top w3-margin-bottom w3-text-teal w3-btn w3-block" style="white-space: normal"
             data-bind="text: titre, click: $parent.play">
        </div>
      </div>

      <footer>
        <div class="w3-container w3-teal">
          <div class="w3-container w3-cell">
            <p>Page <span class="w3-badge w3-white" data-bind="text: page"></span></p>
          </div>
        </div>

        <div class="w3-container w3-teal">
          <div class="w3-container w3-cell">
            <span class="w3-button w3-green w3-round-large" data-bind="click: setSpinPage.bind($data, -10)">-10</span>
            <span class="w3-button w3-green w3-round-large" data-bind="click: setSpinPage.bind($data, -1)">-1</span>
            <span class="w3-button w3-green w3-round-large" data-bind="click: setPage">Page <span data-bind="text: spinPage"></span></span>
            <span class="w3-button w3-green w3-round-large" data-bind="click: setSpinPage.bind($data, 1)">+1</span>
            <span class="w3-button w3-green w3-round-large" data-bind="click: setSpinPage.bind($data, 10)">+10</span>
          </div>
        </div>

        <div class="w3-container w3-teal">
          <div class="w3-container w3-cell w3-text-orange">
            <p data-bind="text: message"></p>
          </div>
        </div>
      </footer>
      
      <script>
        function csbViewModel() {
          var self = this;
          self.player = ko.observable("Stopped");
          self.volume = ko.observable(1);
          self.page = ko.observable(0);
          self.épisodes = ko.observableArray([]);
          self.message = ko.observable("");
          self.enLecture = ko.observable({titre: "", media_id: ""});
          
          self.play = function(épisode) {
            self.command("Start", épisode);
          }
          
          self.playerOff = ko.computed(function () {
            return self.enLecture().titre == "";
          });

          self.stop = function () {
            self.command("Stop", null);
          }

          self.setPage = function () {
            self.command("Page", self.spinPage());
          }

          self.toggle = function () {
            if (self.player() == "Playing") {
              self.command("Pause", null);
            } else if (self.player() == "Paused") {
              self.command("Play", null);
             } 
          }

          self.setVolume = function (offset) {
            var vol = self.volume() + offset;
            if (vol < 0) {
              vol = 0;
            } else if (vol > 10) {
              vol = 10;
            }
            self.command("Volume", vol);
          }

          self.spinPage = ko.observable(1);
          self.setSpinPage = function (offset) {
            var p = self.spinPage() + offset;
            if (p < 1) {
              p = 1;
            } else if (p > 68) {
              p = 68;
            }
            self.spinPage(p);
          }

          self.command = function(verb, param) {
            const headers = new Headers({
                'Content-Type': 'application/json',
            });

            var command = {};
            command[verb] = param;

            const request = new Request('/command', {
              method: 'POST',
              headers: headers,
              cache: 'no-cache',
              redirect: 'error',
              body: JSON.stringify(command),
            });

            fetch(request)
            .then(response => response.json())
            .then(data => {
              self.player(data.player);
              self.volume(data.volume);
              console.log(data.page);
              self.page(data.page);
              self.épisodes.removeAll();
              ko.utils.arrayPushAll(self.épisodes, data.episodes);
              self.message(data.message);
              self.enLecture(data.en_lecture);
            })
            .catch((error) => {
              message = "Échec de fetch: " + error;
              self.message(message);
            });
          };
        }

        var csb = new csbViewModel();
        ko.applyBindings(csb);
        csb.command("State", null);
        setTimeout(() => {
          if (csb.page() == 0) {
            csb.command("Page", 1);
        }}, 100);
        setInterval(() => {
          csb.command("State", null);
        }, 5000);
      </script>
    </body>
</html>