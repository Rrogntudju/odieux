<html>
    <head>
      <meta charset="utf-8"/>
      <meta name="viewport" content="width=device-width, initial-scale=1">
      <script src="dist/knockout-3.5.1.js"></script>
      <link rel="stylesheet" href="dist/w3.css">
      <link rel="icon" type="image/x-icon" href="dist/favicon.ico"/>
      <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
      <style>
        .middle {
          vertical-align: middle
        }
      </style>
    </head>

    <body>
      <header>
        <div class="w3-container w3-round w3-teal">
          <div class="w3-container w3-cell middle">C'est si bon</div>

          <div class="w3-container w3-cell w3-border-left middle">
            <span class="w3-button w3-green w3-round-large" 
                  data-bind="hidden: player() == 'Playing', css: { 'w3-disabled': playerOff }, click: toggle">
              <i class="fa fa-play"></i>
            </span>
            <span class="w3-button w3-green w3-round-large" 
                  data-bind="hidden: player() == 'Paused', css: { 'w3-disabled': playerOff }, click: toggle">
              <i class="fa fa-pause"></i>
            </span>
            <span class="w3-button w3-green w3-round-large" 
                  data-bind="css: { 'w3-disabled': playerOff }, click: stop">
              <i class="fa fa-stop"></i>
            </span>
          </div>

          <div class="w3-container w3-cell middle">
            <span class="w3-button w3-green w3-round-large" 
                  data-bind="css: { 'w3-disabled': playerOff }, click: setVolume.bind($data, -1)">
              <i class="fa fa-volume-down"></i>
            </span>
            <span class="w3-badge w3-white" data-bind="text: volume, css: { 'w3-disabled': playerOff }">

            </span>
            <span class="w3-button w3-green w3-round-large" 
                  data-bind="css: { 'w3-disabled': playerOff }, click: setVolume.bind($data, 1)">
              <i class="fa fa-volume-up"></i>
            </span>
          </div>

          <div class="w3-container w3-cell middle" data-bind="using: enLecture">
            <span data-bind="text: titre"></span>
          </div>
        </div>
      </header>

      <div class= "w3-container" data-bind="foreach: épisodes">
        <div class="w3-card w3-round w3-margin-top w3-margin-bottom w3-text-teal w3-btn w3-block" 
             data-bind="text: titre, click: $parent.play">
        </div>
      </div>

      <footer>
        <div class="w3-container w3-round w3-teal">
          <div class="w3-container w3-cell middle">
            <span>Page <span class="w3-badge w3-white" data-bind="text: page"></span></span>
          </div>

          <div class="w3-container w3-cell middle">
            <span class="w3-button w3-green w3-round-large" data-bind="click: setSpinPage.bind($data, -10)">-10</span>
            <span class="w3-button w3-green w3-round-large" data-bind="click: setSpinPage.bind($data, -1)">-1</span>
            <span class="w3-button w3-green w3-round-large">Page <span data-bind="text: spinPage, click: setPage"></span></span>
            <span class="w3-button w3-green w3-round-large" data-bind="click: setSpinPage.bind($data, 1)">+1</span>
            <span class="w3-button w3-green w3-round-large" data-bind="click: setSpinPage.bind($data, 10)">+10</span>
          </div>

          <div class="w3-container w3-cell w3-text-orange middle">
            <span data-bind="text: message"></span>
          </div>
        </div>
      </footer>
      
      <script>
        document.onreadystatechange = function () {
          csb.command("State", "");
          if (csb.épisodes().length == 0) {
            csb.command("Page", 1);
          }
        }

        function csbViewModel() {
          var self = this;
          /*
          player: ko.observable(""),
          volume: ko.observable(""),
          page: ko.observable(""),
          épisodes: ko.observableArray([]),
          message: ko.observable(""),
          enLecture: ko.observable({titre: "", media_id: ""}),
          */
          self.player = ko.observable("Stopped");
          self.volume = ko.observable(10);
          self.page = ko.observable(1);
          self.épisodes = ko.observableArray([
            { titre: 'Toune 1', media_id: '00000000'  },
            { titre: 'Toune 2', media_id: '00000000'  },
            { titre: 'Toune 2', media_id: '00000000'  },
            { titre: 'Toune 4', media_id: '00000000'  },
            { titre: 'Toune 5', media_id: '00000000'  },
          ]);
          self.message = ko.observable("BEUH!");
          self.enLecture = ko.observable({titre: "", media_id: ""});
          
          self.play = function(épisode) {
            self.command("Start", épisode);
            self.player("Playing"); // temporaire
            self.enLecture(épisode); //temporaire
          }
          
          self.playerOff = ko.computed(function () {
            return self.enLecture().titre == "";
          });

          self.stop = function () {
            self.command("Stop", "");
            self.player("Stopped"); // temporaire
            self.enLecture({titre: "", media_id: ""}); // temporaire
          }

          self.setPage = function () {
            self.command("Page", self.spinPage());
            self.page(self.spinPage()); // temporaire
          }

          self.toggle = function () {
            if (self.player() == "Playing") {
              self.command("Pause", "");
              self.player("Paused"); // temporaire
            } else if (self.player() == "Paused") {
              self.command("Play", "");
              self.player("Playing"); // temporaire
            } 
          }

          self.setVolume = function (offset) {
            var vol = self.volume() + offset;
            if (vol < 0) {
              vol = 0;
            } else if (vol > 10) {
              vol = 10;
            }
            self.command("Volume", vol);
            self.volume(vol); //temporaire
          }

          self.spinPage = ko.observable(1);
          self.setSpinPage = function (offset) {
            var p = self.spinPage() + offset;
            if (p < 1) {
              p = 1;
            } else if (p > 68) {
              p = 68;
            }
            self.spinPage(p);
          }

          self.command = function(verb, param) {
            self.message("");

            const headers = new Headers({
                'Content-Type': 'application/json',
            });

            var body;
            switch (verb) {
              case "Start":
                body = '{ "Start": "' + param + '" }'
                break;
              case "Page":
              case "Volume":
                body = '{ "' + verb + '": ' + param.toString() + ' }'
                break;
              default:
                body = '{ "' + verb + '": null }'
            }

            const request = new Request('/command', {
              method: 'POST',
              headers: headers,
              cache: 'no-cache',
              redirect: 'error',
              body: body
            });

            fetch(request)
            .then(response => response.json())
            .then(data => {
              self.player(data.player);
              self.volume(data.volume.toString());
              self.page(data.page.toString());
              self.épisodes.removeAll();
              for (const épisode of data.episodes) {
                  self.épisodes.push(épisode)
              }
              self.message(data.message);
              self.enLecture(data.enLecture);
            })
            .catch((error) => {
              message = "Échec de fetch: " + error;
              console.log(message);
              self.message(message);
            });
          };
        }
        
        var csb = new csbViewModel();
        ko.applyBindings(csb);
      </script>
    </body>
</html>